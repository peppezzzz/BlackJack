<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blackjack Oracle PRO v4.0</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #bd00ff; --primary-glow: rgba(189, 0, 255, 0.6);
            --bg: #000; --panel: #0a0a0a; --border: #1a1a1a;
            --text: #fff; --win: #00ff88; --lose: #ff0055; --action: #00d4ff;
        }

        body {
            background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }

        /* Navigazione Professionale */
        .tabs { 
            display: flex; background: #050505; border-top: 1px solid var(--border); 
            height: 70px; position: fixed; bottom: 0; width: 100%; z-index: 100;
        }
        .tab-btn { 
            flex: 1; border: none; background: none; color: #555; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
            font-size: 10px; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
        }
        .tab-btn.active { color: var(--primary); }
        .tab-btn i { width: 20px; height: 20px; }

        .section { flex: 1; display: none; padding: 15px; overflow-y: auto; margin-bottom: 75px; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Componenti UI */
        .glass-card { 
            background: var(--panel); border: 1px solid var(--border); border-radius: 16px; 
            padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }

        .target-header { display: flex; gap: 10px; margin-bottom: 15px; }
        .target-box { 
            flex: 1; background: #0f0f0f; border: 2px solid var(--border); border-radius: 12px; 
            padding: 12px; text-align: center; transition: 0.3s; 
        }
        .target-box.active { border-color: var(--primary); box-shadow: 0 0 20px var(--primary-glow); transform: scale(1.02); }
        .sum { font-size: 32px; font-weight: 900; letter-spacing: -1px; }

        .strat-banner { 
            background: linear-gradient(90deg, #000, #111); border: 2px solid var(--primary); 
            border-radius: 12px; padding: 20px; text-align: center; font-size: 24px; font-weight: 900; 
            margin-bottom: 15px; text-transform: uppercase; text-shadow: 0 0 10px var(--primary-glow);
        }

        /* Tastierino Digitale */
        .keypad { display: grid; grid-template-columns: repeat(5, 2fr); gap: 8px; margin-bottom: 15px; }
        .key { 
            height: 65px; border: none; border-radius: 10px; color: white; font-size: 26px; font-weight: 900;
            cursor: pointer; transition: 0.1s; display: flex; align-items: center; justify-content: center;
        }
        .key:active { transform: scale(0.92); opacity: 0.8; }
        .k-high { background: #d32f2f; } .k-low { background: #2e7d32; } .k-mid { background: #455a64; }

        /* Analisi Mazzo */
        .prob-bar { height: 6px; background: #222; border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .prob-fill { height: 100%; transition: 1s ease-out; }

        /* Finanze Table */
        .f-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #1a1a1a; }
        .f-label { color: #888; font-size: 14px; }
        .f-val { font-weight: bold; font-size: 16px; }

        /* Pulsanti Azione */
        .btn-main { 
            background: var(--primary); border: none; border-radius: 12px; padding: 18px; 
            color: white; font-weight: 900; font-size: 16px; width: 100%; letter-spacing: 2px;
            box-shadow: 0 0 20px var(--primary-glow); margin-top: 10px;
        }

        #config-sec { background: #000; z-index: 1000; position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; }
        .config-input { 
            background: #111; border: 1px solid var(--border); border-radius: 10px; 
            padding: 15px; color: white; width: 100%; margin: 10px 0; font-size: 18px; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="config-sec" class="section active">
        <div style="padding: 30px;">
            <div style="text-align:center; margin-bottom: 40px;">
                <h1 style="color:var(--primary); font-size: 42px; margin:0;">ORACLE</h1>
                <p style="color:#555; letter-spacing:3px;">PRO EDITION v4.0</p>
            </div>
            <label class="f-label">BANKROLL INIZIALE (€)</label>
            <input type="number" id="cfg-bank" class="config-input" value="1000">
            <label class="f-label">NUMERO MAZZI (INFINITE = 8)</label>
            <input type="number" id="cfg-decks" class="config-input" value="8">
            <label class="f-label">PUNTO DI TAGLIO (%)</label>
            <input type="number" id="cfg-pen" class="config-input" value="50">
            <button class="btn-main" onclick="initApp()">ATTIVA SISTEMA</button>
        </div>
    </div>

    <div id="game-sec" class="section">
        <div class="target-header">
            <div id="box-p1" class="target-box active" onclick="setT('p1')">
                <div class="f-label">PLAYER A</div>
                <div id="sum-p1" class="sum">0</div>
            </div>
            <div id="box-p2" class="target-box" style="display:none" onclick="setT('p2')">
                <div class="f-label">PLAYER B</div>
                <div id="sum-p2" class="sum">0</div>
            </div>
            <div id="box-d" class="target-box" onclick="setT('d')">
                <div class="f-label">DEALER</div>
                <div id="sum-d" class="sum">0</div>
            </div>
        </div>

        <div id="strat-box" class="strat-banner">READY</div>

        <div class="glass-card" style="display: flex; gap: 15px;">
            <div style="flex:1">
                <div class="f-label">PROB 10</div>
                <div id="p10-txt" style="font-size:20px; font-weight:900; color:var(--action)">30.7%</div>
                <div class="prob-bar"><div id="p10-bar" class="prob-fill" style="background:var(--action); width:30%"></div></div>
            </div>
            <div style="flex:1">
                <div class="f-label">PROB ASSO</div>
                <div id="pa-txt" style="font-size:20px; font-weight:900; color:var(--win)">7.7%</div>
                <div class="prob-bar"><div id="pa-bar" class="prob-fill" style="background:var(--win); width:8%"></div></div>
            </div>
        </div>

        <div class="keypad">
            <button class="key k-high" onclick="hit(11)">A</button>
            <button class="key k-low" onclick="hit(2)">2</button>
            <button class="key k-low" onclick="hit(3)">3</button>
            <button class="key k-low" onclick="hit(4)">4</button>
            <button class="key k-low" onclick="hit(5)">5</button>
            <button class="key k-low" onclick="hit(6)">6</button>
            <button class="key k-mid" onclick="hit(7)">7</button>
            <button class="key k-mid" onclick="hit(8)">8</button>
            <button class="key k-mid" onclick="hit(9)">9</button>
            <button class="key k-high" onclick="hit(10)">10</button>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="act-btn" style="flex:1; background:#111; border:1px solid #333; color:#fff; border-radius:10px; padding:15px;" onclick="undo()">UNDO</button>
            <button id="split-btn" class="act-btn" style="flex:1; background:#001a33; border:1px solid var(--action); color:var(--action); border-radius:10px; display:none;" onclick="split()">SPLIT</button>
            <button class="btn-main" style="flex:2; margin-top:0;" onclick="resolve()">FINE MANO</button>
        </div>

        <div class="glass-card" style="display:grid; grid-template-columns: repeat(4, 1fr); margin-top:15px; text-align:center;">
            <div><div class="f-label">RC</div><div id="ui-rc" style="color:var(--primary); font-weight:bold;">0</div></div>
            <div><div class="f-label">TC</div><div id="ui-tc" style="color:var(--primary); font-weight:bold;">0.0</div></div>
            <div><div class="f-label">BET</div><div id="ui-bet" style="color:var(--win); font-weight:bold;">1€</div></div>
            <div><div class="f-label">CARTE</div><div id="ui-dealt">0</div></div>
        </div>
    </div>

    <div id="fin-sec" class="section">
        <h2 style="color:var(--primary)">PERFORMANCE</h2>
        <div class="glass-card">
            <div class="f-row"><span class="f-label">SALDO ATTUALE</span><span id="ui-bal" class="f-val">1000€</span></div>
            <div class="f-row"><span class="f-label">PROFITTO NETTO</span><span id="ui-prof" class="f-val">0€</span></div>
            <div class="f-row"><span class="f-label">RENDIMENTO (ROI)</span><span id="ui-roi" class="f-val">0.0%</span></div>
        </div>
        <div class="glass-card">
            <div class="f-row"><span class="f-label">MANI TOTALI</span><span id="ui-h">0</span></div>
            <div class="f-row"><span class="f-label">VINTE / PERSE</span><span><span id="ui-w" style="color:var(--win)">0</span> / <span id="ui-l" style="color:var(--lose)">0</span></span></div>
        </div>
        <h3 class="f-label" style="margin-top:20px;">CRONOLOGIA SESSIONE</h3>
        <div id="history-list"></div>
    </div>

    <div class="tabs" id="nav-bar" style="display:none;">
        <button class="tab-btn" onclick="nav('fin-sec', this)"><i data-lucide="trending-up"></i>Finanze</button>
        <button class="tab-btn active" onclick="nav('game-sec', this)"><i data-lucide="activity"></i>Oracle</button>
        <button class="tab-btn" onclick="fullReset()"><i data-lucide="refresh-cw"></i>Reset</button>
    </div>

    <script>
        // Audio Engine
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, dur) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        let s = {
            bank: 1000, start: 1000, decks: 8, pen: 50, rc: 0, dealt: 0,
            c10: 0, cA: 0, p1: [], p2: [], d: [], target: 'p1', isSplit: false,
            stats: { h: 0, w: 0, l: 0 }, hist: [], log: []
        };

        const TAGS = { 11: -1, 2: 1, 3: 1, 4: 1, 5: 1, 6: 1, 7: 0, 8: 0, 9: 0, 10: -1 };

        function initApp() {
            s.start = parseFloat(document.getElementById('cfg-bank').value) || 1000;
            s.bank = s.start; s.decks = parseInt(document.getElementById('cfg-decks').value) || 8;
            s.pen = parseInt(document.getElementById('cfg-pen').value) || 50;
            document.getElementById('config-sec').style.display = 'none';
            document.getElementById('nav-bar').style.display = 'flex';
            nav('game-sec', document.querySelectorAll('.tab-btn')[1]);
            playTone(880, 'sine', 0.1); update();
        }

        function hit(v) {
            playTone(440, 'sine', 0.05);
            s.rc += TAGS[v]; s.dealt++; s.log.push({ v, t: s.target });
            s[s.target].push(v);
            if (v === 10) s.c10++; if (v === 11) s.cA++;
            
            // Auto-switch per Infinite Blackjack
            if (!s.isSplit && s.p1.length === 1 && s.d.length === 0) s.target = 'd';
            else if (!s.isSplit && s.p1.length === 1 && s.d.length === 1) s.target = 'p1';

            update(); save();
        }

        function getSum(h) {
            let v = h.reduce((a, b) => a + b, 0), aces = h.filter(x => x === 11).length;
            while (v > 21 && aces > 0) { v -= 10; aces--; }
            return v;
        }

        function getTC() { return s.rc / Math.max(1, (s.decks * 52 - s.dealt) / 52); }

        function resolve() {
            let tc = getTC(), ds = getSum(s.d);
            let bet = (tc < 1) ? 1 : (tc < 2) ? 2 : (tc < 3) ? 5 : (tc < 4.5) ? 8 : 12;
            let hands = [s.p1]; if (s.isSplit) hands.push(s.p2);

            hands.forEach(h => {
                let ps = getSum(h), res = "", gain = 0; s.stats.h++;
                if (ps > 21) { res = "LOSE (BUST)"; gain = -bet; s.stats.l++; playTone(200, 'sawtooth', 0.3); }
                else if (ds > 21 || ps > ds) { res = "WIN"; gain = (ps === 21 && h.length === 2) ? bet * 1.5 : bet; s.stats.w++; playTone(1200, 'sine', 0.2); }
                else if (ps < ds) { res = "LOSE"; gain = -bet; s.stats.l++; }
                else { res = "PUSH"; gain = 0; }
                s.bank += gain; s.hist.unshift({ m: res, s: `${ps} vs ${ds}`, v: gain + "€", c: gain > 0 ? 'var(--win)' : 'var(--lose)' });
            });

            s.p1 = []; s.p2 = []; s.d = []; s.target = 'p1'; s.isSplit = false;
            update(); save();
        }

        function update() {
            let tc = getTC(), ps = getSum(s[s.target === 'd' ? 'p1' : s.target]), dv = s.d[0] || 0;
            let totalCards = s.decks * 52;
            let rem = totalCards - s.dealt;
            let p10 = (((s.decks * 16) - s.c10) / rem * 100).toFixed(1);
            let pA = (((s.decks * 4) - s.cA) / rem * 100).toFixed(1);

            document.getElementById('p10-txt').innerText = p10 + "%";
            document.getElementById('p10-bar').style.width = p10 + "%";
            document.getElementById('pa-txt').innerText = pA + "%";
            document.getElementById('pa-bar').style.width = pA + "%";

            document.getElementById('sum-p1').innerText = getSum(s.p1);
            document.getElementById('sum-p2').innerText = getSum(s.p2);
            document.getElementById('sum-d').innerText = getSum(s.d);
            document.getElementById('ui-rc').innerText = (s.rc > 0 ? '+' : '') + s.rc;
            document.getElementById('ui-tc').innerText = tc.toFixed(1);
            document.getElementById('ui-bet').innerText = (tc < 1 ? 1 : tc < 2 ? 2 : tc < 3 ? 5 : tc < 4.5 ? 8 : 12) + "€";
            document.getElementById('ui-dealt').innerText = s.dealt;

            // Strategy Logic
            let advice = "WAITING", col = "var(--primary)";
            let isSoft = s[s.target].includes(11) && getSum(s[s.target]) <= 21;
            let isPair = s[s.target].length === 2 && s[s.target][0] === s[s.target][1];

            if (ps > 21) advice = "BUST", col = "var(--lose)";
            else if (ps > 0 && dv > 0) {
                if (isPair) {
                    let v = s[s.target][0];
                    if (v === 11 || v === 8) advice = "SPLIT", col = "var(--action)";
                    else if (v === 10) advice = "STAND", col = "var(--lose)";
                    else advice = (dv <= 7) ? "SPLIT" : "HIT", col = (dv <= 7) ? "var(--action)" : "var(--win)";
                } else if (isSoft) {
                    if (ps >= 19) advice = "STAND", col = "var(--lose)";
                    else advice = (dv >= 3 && dv <= 6) ? "DOUBLE" : "HIT", col = (dv >= 3 && dv <= 6) ? "var(--action)" : "var(--win)";
                } else {
                    if (ps >= 17) advice = "STAND", col = "var(--lose)";
                    else if (ps >= 13) advice = (dv <= 6) ? "STAND" : "HIT", col = (dv <= 6) ? "var(--lose)" : "var(--win)";
                    else if (ps === 11) advice = "DOUBLE", col = "var(--action)";
                    else advice = "HIT", col = "var(--win)";
                }
            }
            let sb = document.getElementById('strat-box'); sb.innerText = advice; sb.style.color = col; sb.style.borderColor = col;

            // UI Elements
            document.getElementById('split-btn').style.display = (!s.isSplit && isPair) ? 'block' : 'none';
            document.getElementById('box-p2').style.display = s.isSplit ? 'block' : 'none';
            document.getElementById('box-p1').className = "target-box " + (s.target === 'p1' ? 'active' : '');
            document.getElementById('box-p2').className = "target-box " + (s.target === 'p2' ? 'active' : '');
            document.getElementById('box-d').className = "target-box " + (s.target === 'd' ? 'active' : '');
            
            // Side Bets Alerts
            document.getElementById('btn-ins').className = (dv === 11 && tc >= 3) ? "side-btn active" : "side-btn";
            document.getElementById('btn-side').className = (tc >= 5) ? "side-btn active" : "side-btn";
            if(tc >= 5) playTone(600, 'sine', 0.1);

            // Finance Page
            document.getElementById('ui-bal').innerText = Math.round(s.bank) + "€";
            document.getElementById('ui-prof').innerText = (s.bank - s.start).toFixed(0) + "€";
            document.getElementById('ui-roi').innerText = (((s.bank - s.start) / s.start) * 100).toFixed(1) + "%";
            document.getElementById('ui-h').innerText = s.stats.h;
            document.getElementById('ui-w').innerText = s.stats.w; document.getElementById('ui-l').innerText = s.stats.l;

            let hHtml = ""; s.hist.slice(0, 15).forEach(i => {
                hHtml += `<div class="glass-card hist-row" style="margin-bottom:8px; display:flex; justify-content:space-between;"><span style="font-weight:bold">${i.m}</span><span style="color:${i.c}">${i.v}</span></div>`;
            });
            document.getElementById('history-list').innerHTML = hHtml;
        }

        function undo() { if (s.log.length) { let l = s.log.pop(); s[l.t].pop(); s.rc -= TAGS[l.v]; if (l.v === 10) s.count10--; if (l.v === 11) s.countA--; s.dealt--; update(); } }
        function split() { s.isSplit = true; s.p2 = [s.p1.pop()]; s.target = 'p1'; update(); }
        function setT(t) { s.target = t; update(); }
        function nav(sec, btn) { 
            document.querySelectorAll('.section').forEach(x => x.classList.remove('active')); 
            document.getElementById(sec).classList.add('active'); 
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active')); 
            btn.classList.add('active'); 
            lucide.createIcons();
        }
        function save() { localStorage.setItem('oracle_v4', JSON.stringify(s)); }
        function load() { let d = localStorage.getItem('oracle_v4'); if (d) { s = JSON.parse(d); document.getElementById('config-sec').style.display = 'none'; document.getElementById('nav-bar').style.display = 'flex'; update(); } }
        function fullReset() { if (confirm("ELIMINARE TUTTI I DATI?")) { localStorage.clear(); location.reload(); } }

        window.onload = () => { load(); lucide.createIcons(); };
    </script>
</body>
</html>
