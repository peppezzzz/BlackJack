<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BJ Counter</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
  <style>
    body { 
      background: #121212; 
      color: #e0e0e0; 
      font-family: 'Roboto', sans-serif; 
      margin: 0; 
      padding: 0; 
      display: flex; 
      flex-direction: column; 
      min-height: 100vh;
    }
    .header { 
      background: #1e1e1e; 
      padding: 15px; 
      text-align: center; 
      border-bottom: 1px solid #333;
    }
    .count { 
      font-size: 28px; 
      color: #4caf50;
    }
    .suggested-bet { 
      font-size: 20px; 
      color: #2196f3; 
      margin-top: 5px;
    }
    .main { 
      flex: 1; 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      align-items: center;
    }
    .hands { 
      width: 100%; 
      max-width: 400px; 
      background: #252525; 
      padding: 15px; 
      border-radius: 8px; 
      margin-bottom: 15px;
    }
    .hand { 
      margin: 10px 0; 
      font-size: 18px;
    }
    .action-suggestion { 
      background: #333; 
      padding: 15px; 
      border-radius: 8px; 
      text-align: center; 
      font-weight: bold; 
      color: #ffeb3b; 
      margin-bottom: 15px;
    }
    .outcome { 
      font-size: 24px; 
      text-align: center; 
      margin-bottom: 15px; 
      padding: 10px; 
      border-radius: 8px;
    }
    .outcome-win { background: #4caf50; color: #fff; }
    .outcome-loss { background: #f44336; color: #fff; }
    .outcome-push { background: #ffc107; color: #000; }
    .side-boxes { 
      display: flex; 
      justify-content: space-around; 
      width: 100%; 
      max-width: 400px; 
      margin-bottom: 15px;
    }
    .side-box { 
      padding: 10px; 
      border-radius: 8px; 
      text-align: center; 
      width: 45%; 
      cursor: pointer;
    }
    .insurance { background: #607d8b; }
    .insurance.active { background: #2196f3; color: #fff; }
    .side-bet { background: #607d8b; }
    .side-bet.active { background: #ff9800; color: #fff; }
    .footer { 
      background: #1e1e1e; 
      padding: 15px; 
      border-top: 1px solid #333; 
      display: grid; 
      grid-template-columns: 1fr 1fr 1fr; 
      gap: 15px;
    }
    .finances { 
      background: #252525; 
      padding: 10px; 
      border-radius: 8px; 
      font-size: 14px;
    }
    .history { 
      max-height: 200px; 
      overflow-y: auto;
    }
    .counter-section { 
      display: flex; 
      flex-direction: column; 
      align-items: center;
    }
    .buttons { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 10px; 
      margin-bottom: 10px;
    }
    button { 
      background: linear-gradient(135deg, #333, #444); 
      color: #fff; 
      border: none; 
      padding: 12px; 
      font-size: 16px; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: transform 0.1s;
    }
    button:hover { transform: scale(1.05); }
    .assign-btn { background: linear-gradient(135deg, #4caf50, #388e3c); }
    .undo-btn { background: linear-gradient(135deg, #ffc107, #f57c00); }
    .extra-cards { 
      background: #333; 
      padding: 10px; 
      border-radius: 8px; 
      text-align: center; 
      margin-top: 10px;
    }
    .settings { 
      background: #252525; 
      padding: 10px; 
      border-radius: 8px; 
      font-size: 14px;
    }
    .recap { margin-bottom: 10px; }
    @media (max-width: 600px) { 
      .footer { grid-template-columns: 1fr; }
      .side-boxes { flex-direction: column; }
      .side-box { width: 100%; margin-bottom: 10px; }
    }
    /* Stealth mode remains similar */
  </style>
</head>
<body>
  <div class="header">
    <div class="count">Running: 0 | True: 0</div>
    <div class="suggested-bet">Bet Consigliata: 10</div>
  </div>
  <div class="main">
    <div class="hands">
      <div class="hand" id="playerHand">Le tue carte: </div>
      <div class="hand" id="dealerHand">Carte del banco: </div>
      <div id="splitHands"></div>
    </div>
    <div class="action-suggestion">Suggerimento: -</div>
    <div class="outcome" id="outcomeMsg" style="display: none;"></div>
    <div class="side-boxes">
      <div class="side-box insurance" id="insuranceBox">Assicurazione: No</div>
      <div class="side-box side-bet" id="sideBetBox">Side Bet (Bust It): No</div>
    </div>
  </div>
  <div class="footer">
    <div class="finances">
      <div>Bankroll: <span id="bankroll">1000</span></div>
      <div>Saldo: <span id="saldo">1000</span></div>
      <div>ROI: <span id="roi">0%</span></div>
      <div>Mani: <span id="mani">0</span></div>
      <div>Vinte: <span id="vinte">0</span></div>
      <div>Perse: <span id="perse">0</span></div>
      <div>Pareggi: <span id="pareggi">0</span></div>
      <div>Bust Tuoi: <span id="bustTuoi">0</span></div>
      <div>Bust Dealer: <span id="bustDealer">0</span></div>
      <div class="history" id="history"></div>
    </div>
    <div class="counter-section">
      <div class="buttons">
        <button onclick="addCard('2')">2</button>
        <button onclick="addCard('3')">3</button>
        <button onclick="addCard('4')">4</button>
        <button onclick="addCard('5')">5</button>
        <button onclick="addCard('6')">6</button>
        <button onclick="addCard('7')">7</button>
        <button onclick="addCard('8')">8</button>
        <button onclick="addCard('9')">9</button>
        <button onclick="addCard('10')">10</button>
        <button onclick="addCard('A')">A</button>
      </div>
      <div>
        <button class="assign-btn" onclick="toMe()">A me</button>
        <button class="assign-btn" onclick="toDealer()">Al banco</button>
        <button onclick="splitHand()">Split</button>
        <button onclick="endHand()">Fine Mano</button>
        <button class="undo-btn" onclick="undoLastCard()">Annulla Ultima</button>
      </div>
      <div class="extra-cards">
        <button onclick="addExtraCard('2')">2</button> <!-- Ripeti per tutte carte, o usa same buttons in post mode -->
        <!-- Per semplicità, assumi same buttons work in post mode for extra -->
      </div>
    </div>
    <div class="settings">
      <div class="recap">
        Decks: <span id="recapDecks">8</span><br>
        Penetration: <span id="recapPen">75%</span><br>
        Bankroll: <span id="recapBank">1000</span><br>
        Bet Size: <span id="recapBet">10</span><br>
        Sistema: <span id="recapSystem">Hi-Lo</span><br>
        Bust It: <span id="recapBustIt">No</span>
      </div>
      <label>Decks: <input id="decks" type="number" value="8"></label>
      <label>Penetration (%): <input id="penetration" type="number" value="75"></label>
      <label>Bankroll: <input id="initBankroll" type="number" value="1000"></label>
      <label>Bet Size: <input id="betSize" type="number" value="10"></label>
      <label>Sistema: <select id="system"><option>Hi-Lo</option><option>KO</option></select></label>
      <label>Side Bets: <input type="checkbox" id="bustIt"> Bust It</label>
      <button onclick="saveSettings()">Salva</button>
      <button onclick="resetCount()">Reset Conteggio</button>
      <button onclick="resetAll()">Reset Tutto</button>
      <button onclick="toggleStealth()">Stealth</button>
      <button onclick="exportHistory()">Export CSV</button>
    </div>
  </div>
  <script>
    const cardValues = { '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'A':11 };
    let runningCount = 0;
    let cardsDealt = 0;
    let decks = 8;
    let penetration = 0.75;
    let bankroll = 1000;
    let saldo = bankroll;
    let betSize = 10;
    let mani = 0;
    let vinte = 0;
    let perse = 0;
    let pareggi = 0;
    let bustTuoi = 0;
    let bustDealer = 0;
    let history = [];
    let handPlayer = [];
    let handDealer = [];
    let splitHands = []; 
    let isSplit = false;
    let inputCount = 0;
    let assignTo = 'player';
    let postHandMode = false;
    let countSystem = 'Hi-Lo';
    let bustItActive = false;
    let stealthMode = false;
    let lastActions = []; // For undo: {card, assign}
    let outcome = '';

    function loadData() {
      // Same as before
      updateAll();
    }
    loadData();

    function saveSettings() {
      // Same
      updateRecap();
      updateAll();
    }

    function addCard(card) {
      if (postHandMode) {
        runningCount += getCountValue(card);
        cardsDealt++;
        vibrateIfHigh();
        updateCount();
        return;
      }
      // Same add logic
      lastActions.push({card, assign: assignTo});
      // ... rest same
    }

    function addExtraCard(card) {
      addCard(card); // Since postHandMode handles it as extra
    }

    function undoLastCard() {
      if (lastActions.length > 0) {
        let last = lastActions.pop();
        runningCount -= getCountValue(last.card);
        cardsDealt--;
        if (last.assign === 'player') handPlayer.pop();
        else if (last.assign === 'dealer') handDealer.pop();
        updateAll();
      }
    }

    function endHand() {
      // Same, but set outcome
      // After calculations
      if (totalNet > 0) outcome = 'Hai vinto!';
      else if (totalNet < 0) outcome = 'Hai perso!';
      else outcome = 'Hai pareggiato!';
      document.getElementById('outcomeMsg').innerText = outcome;
      document.getElementById('outcomeMsg').style.display = 'block';
      document.getElementById('outcomeMsg').className = totalNet > 0 ? 'outcome outcome-win' : totalNet < 0 ? 'outcome outcome-loss' : 'outcome outcome-push';
      // ... rest
    }

    function resetHand() {
      // Same
      outcome = '';
      document.getElementById('outcomeMsg').style.display = 'none';
      lastActions = [];
    }

    function resetCount() {
      runningCount = 0;
      cardsDealt = 0;
      updateCount();
    }

    function resetAll() {
      localStorage.clear();
      location.reload();
    }

    function updateCount() {
      // Same
      let tc = getTrueCount();
      let suggested = Math.max(betSize, betSize * Math.max(1, Math.floor(tc + 1)));
      document.querySelector('.suggested-bet').innerText = `Bet Consigliata: ${suggested}`;
    }

    function updateSuggestion() {
      // Same
      let tc = getTrueCount();
      let dealerUp = handDealer[0] || null;
      if (dealerUp === 'A' && tc >= 3) {
        document.getElementById('insuranceBox').innerText = 'Assicurazione: Sì';
        document.getElementById('insuranceBox').classList.add('active');
      } else {
        document.getElementById('insuranceBox').innerText = 'Assicurazione: No';
        document.getElementById('insuranceBox').classList.remove('active');
      }
      // For side bet, simplify: if bustItActive and tc <0 (low cards favor dealer bust?), but optional
      if (bustItActive && tc < 0) {
        document.getElementById('sideBetBox').innerText = 'Side Bet (Bust It): Sì';
        document.getElementById('sideBetBox').classList.add('active');
      } else {
        document.getElementById('sideBetBox').innerText = 'Side Bet (Bust It): No';
        document.getElementById('sideBetBox').classList.remove('active');
      }
      document.querySelector('.action-suggestion').innerText = `Suggerimento: ${suggestions.join(' | ')}`;
    }

    function updateRecap() {
      document.getElementById('recapDecks').innerText = decks;
      document.getElementById('recapPen').innerText = penetration * 100 + '%';
      document.getElementById('recapBank').innerText = bankroll;
      document.getElementById('recapBet').innerText = betSize;
      document.getElementById('recapSystem').innerText = countSystem;
      document.getElementById('recapBustIt').innerText = bustItActive ? 'Sì' : 'No';
    }

    // Rest of functions same as before
    function getCountValue(card) { /* same */ }
    function toMe() { /* same */ }
    function toDealer() { /* same */ }
    function splitHand() { /* same */ }
    function resetShoe() { resetCount(); } // Alias
    function updateHandsDisplay() { /* same */ }
    function updateFinances() { /* same */ }
    function updateHistory() { /* same */ }
    function exportHistory() { /* same */ }
    function toggleStealth() { /* same */ }
    function vibrateIfHigh() { /* same */ }
    function updateAll() { 
      updateCount();
      updateHandsDisplay();
      updateSuggestion();
      updateFinances();
      updateHistory();
      updateRecap();
    }
    function getTrueCount() { /* same */ }
    function getAction(hand, dealerUp, tc) { /* same, expand if needed */ }
    function calculateHand(hand) { /* same */ }
  </script>
</body>
</html>
