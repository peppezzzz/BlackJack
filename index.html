<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BJ Counter</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
  <style>
    body { 
      background: #121212; 
      color: #e0e0e0; 
      font-family: 'Roboto', sans-serif; 
      margin: 0; 
      padding: 0; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      min-height: 100vh;
    }
    .container { 
      max-width: 400px; 
      width: 100%; 
      padding: 20px; 
      background: #1e1e1e; 
      border-radius: 12px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .count { 
      font-size: 28px; 
      text-align: center; 
      margin-bottom: 10px; 
      color: #4caf50;
    }
    .suggestion { 
      color: #ffeb3b; 
      text-align: center; 
      font-weight: bold; 
      margin-bottom: 15px;
    }
    .hands { 
      background: #252525; 
      padding: 10px; 
      border-radius: 8px; 
      margin-bottom: 15px;
    }
    .hand { 
      margin: 5px 0; 
      font-size: 16px;
    }
    .buttons { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 10px; 
      margin-bottom: 15px;
    }
    button { 
      background: linear-gradient(135deg, #333, #444); 
      color: #fff; 
      border: none; 
      padding: 15px; 
      font-size: 18px; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: transform 0.1s, background 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    button:hover { 
      transform: scale(1.05); 
      background: linear-gradient(135deg, #444, #555);
    }
    button.action { 
      background: linear-gradient(135deg, #4caf50, #388e3c); 
    }
    button.reset { 
      background: linear-gradient(135deg, #f44336, #d32f2f); 
    }
    .post-hand { 
      color: #9e9e9e; 
      text-align: center; 
      margin: 10px 0;
    }
    .finances { 
      background: #252525; 
      padding: 15px; 
      border-radius: 8px; 
      margin-bottom: 15px; 
      font-size: 14px;
    }
    .history { 
      max-height: 150px; 
      overflow-y: auto; 
      background: #252525; 
      padding: 10px; 
      border-radius: 8px; 
      margin-bottom: 15px; 
      font-size: 12px;
    }
    .settings { 
      background: #252525; 
      padding: 15px; 
      border-radius: 8px; 
      font-size: 14px;
    }
    input, select { 
      background: #333; 
      color: #fff; 
      border: 1px solid #444; 
      padding: 8px; 
      border-radius: 4px; 
      margin: 5px 0;
    }
    label { 
      display: block; 
      margin-bottom: 5px;
    }
    /* Stealth mode */
    .stealth .count, .stealth .suggestion, .stealth .hands, .stealth .post-hand, .stealth .finances, .stealth .history, .stealth .settings { display: none; }
    .stealth .buttons { grid-template-columns: repeat(4, 1fr); }
    .stealth button:not(.calc-btn) { display: none; }
    .stealth .container { box-shadow: none; background: transparent; }
  </style>
</head>
<body>
  <div class="container">
    <div class="count">Running: 0 | True: 0</div>
    <div class="suggestion">Suggerimento: -</div>
    <div class="hands">
      <div class="hand" id="playerHand">Player: </div>
      <div class="hand" id="dealerHand">Dealer: </div>
      <div class="split" id="splitHands"></div>
    </div>
    <div class="buttons">
      <button class="calc-btn" onclick="addCard('2')">2</button>
      <button class="calc-btn" onclick="addCard('3')">3</button>
      <button class="calc-btn" onclick="addCard('4')">4</button>
      <button class="calc-btn" onclick="addCard('5')">5</button>
      <button class="calc-btn" onclick="addCard('6')">6</button>
      <button class="calc-btn" onclick="addCard('7')">7</button>
      <button class="calc-btn" onclick="addCard('8')">8</button>
      <button class="calc-btn" onclick="addCard('9')">9</button>
      <button class="calc-btn" onclick="addCard('10')">10</button>
      <button class="calc-btn" onclick="addCard('J')">J</button>
      <button class="calc-btn" onclick="addCard('Q')">Q</button>
      <button class="calc-btn" onclick="addCard('K')">K</button>
      <button class="calc-btn" onclick="addCard('A')">A</button>
      <button class="action" onclick="toMe()">A me</button>
      <button class="action" onclick="toDealer()">Al dealer</button>
      <button class="action" onclick="splitHand()">Split</button>
      <button class="action" onclick="endHand()">Fine Mano</button>
      <button class="reset" onclick="resetHand()">Reset Mano</button>
      <button class="reset" onclick="resetShoe()">Reset Shoe</button>
      <button onclick="toggleStealth()">Stealth</button>
      <button onclick="exportHistory()">Export CSV</button>
    </div>
    <div class="post-hand" id="postHandMsg" style="display: none;">Post-mano: Aggiungi carte extra per conteggio</div>
    <div class="finances">
      Bankroll: <span id="bankroll">1000</span> | Saldo: <span id="saldo">1000</span> | ROI: <span id="roi">0%</span><br>
      Mani: <span id="mani">0</span> | Vinte: <span id="vinte">0</span> | Perse: <span id="perse">0</span> | Pareggi: <span id="pareggi">0</span><br>
      Bust Tuoi: <span id="bustTuoi">0</span> | Bust Dealer: <span id="bustDealer">0</span>
    </div>
    <div class="history" id="history"></div>
    <div class="settings">
      <label>Decks: <input id="decks" type="number" value="8"></label>
      <label>Penetration (%): <input id="penetration" type="number" value="75"></label>
      <label>Bankroll: <input id="initBankroll" type="number" value="1000"></label>
      <label>Bet Size: <input id="betSize" type="number" value="10"></label>
      <label>Sistema: <select id="system"><option>Hi-Lo</option><option>KO</option></select></label>
      <label>Side Bets: <input type="checkbox" id="bustIt"> Bust It</label>
      <button class="action" onclick="saveSettings()">Salva</button>
    </div>
  </div>
  <script>
    // Il codice JS rimane lo stesso del precedente, con tutte le funzioni
    // Copia e incolla il <script> dal codice precedente qui
    const cardValues = { '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':10, 'Q':10, 'K':10, 'A':11 };
    let runningCount = 0;
    let cardsDealt = 0;
    let decks = 8;
    let penetration = 0.75;
    let bankroll = 1000;
    let saldo = bankroll;
    let betSize = 10;
    let mani = 0;
    let vinte = 0;
    let perse = 0;
    let pareggi = 0;
    let bustTuoi = 0;
    let bustDealer = 0;
    let history = [];
    let handPlayer = [];
    let handDealer = [];
    let splitHands = []; 
    let isSplit = false;
    let inputCount = 0;
    let assignTo = 'player';
    let postHandMode = false;
    let countSystem = 'Hi-Lo';
    let bustItActive = false;
    let stealthMode = false;

    function loadData() {
      if (localStorage.runningCount) runningCount = parseInt(localStorage.runningCount);
      if (localStorage.cardsDealt) cardsDealt = parseInt(localStorage.cardsDealt);
      if (localStorage.decks) decks = parseInt(localStorage.decks);
      if (localStorage.penetration) penetration = parseFloat(localStorage.penetration);
      if (localStorage.bankroll) bankroll = parseFloat(localStorage.bankroll);
      if (localStorage.saldo) saldo = parseFloat(localStorage.saldo);
      if (localStorage.betSize) betSize = parseFloat(localStorage.betSize);
      if (localStorage.mani) mani = parseInt(localStorage.mani);
      if (localStorage.vinte) vinte = parseInt(localStorage.vinte);
      if (localStorage.perse) perse = parseInt(localStorage.perse);
      if (localStorage.pareggi) pareggi = parseInt(localStorage.pareggi);
      if (localStorage.bustTuoi) bustTuoi = parseInt(localStorage.bustTuoi);
      if (localStorage.bustDealer) bustDealer = parseInt(localStorage.bustDealer);
      if (localStorage.history) history = JSON.parse(localStorage.history);
      if (localStorage.countSystem) countSystem = localStorage.countSystem;
      if (localStorage.bustItActive) bustItActive = JSON.parse(localStorage.bustItActive);
      updateAll();
    }
    loadData();

    function saveSettings() {
      decks = parseInt(document.getElementById('decks').value);
      penetration = parseFloat(document.getElementById('penetration').value) / 100;
      bankroll = parseFloat(document.getElementById('initBankroll').value);
      saldo = bankroll; 
      betSize = parseFloat(document.getElementById('betSize').value);
      countSystem = document.getElementById('system').value;
      bustItActive = document.getElementById('bustIt').checked;
      localStorage.decks = decks;
      localStorage.penetration = penetration;
      localStorage.bankroll = bankroll;
      localStorage.saldo = saldo;
      localStorage.betSize = betSize;
      localStorage.countSystem = countSystem;
      localStorage.bustItActive = bustItActive;
      updateAll();
    }

    function addCard(card) {
      if (postHandMode) {
        runningCount += getCountValue(card);
        cardsDealt++;
        vibrateIfHigh();
        updateCount();
        return;
      }
      if (inputCount < 3) {
        if (inputCount === 0 || inputCount === 2) {
          if (isSplit) {
            splitHands[inputCount / 2].push(card); 
          } else {
            handPlayer.push(card);
          }
        } else if (inputCount === 1) {
          handDealer.push(card);
        }
        inputCount++;
      } else {
        if (assignTo === 'player') {
          if (isSplit) {
            splitHands[0].push(card);
          } else {
            handPlayer.push(card);
          }
        } else {
          handDealer.push(card);
        }
      }
      runningCount += getCountValue(card);
      cardsDealt++;
      vibrateIfHigh();
      updateCount();
      updateHandsDisplay();
      updateSuggestion();
    }

    function getCountValue(card) {
      if (countSystem === 'Hi-Lo') {
        if (['2','3','4','5','6'].includes(card)) return 1;
        if (['10','J','Q','K','A'].includes(card)) return -1;
        return 0;
      } else if (countSystem === 'KO') {
        if (['2','3','4','5','6','7'].includes(card)) return 1;
        if (['10','J','Q','K','A'].includes(card)) return -1;
        return 0;
      }
      return 0;
    }

    function toMe() { assignTo = 'player'; }
    function toDealer() { assignTo = 'dealer'; }

    function splitHand() {
      if (handPlayer.length === 2 && handPlayer[0] === handPlayer[1]) {
        splitHands = [[handPlayer[0]], [handPlayer[1]]];
        isSplit = true;
        handPlayer = [];
        updateHandsDisplay();
        updateSuggestion();
      }
    }

    function endHand() {
      if (postHandMode) return;
      let nets = [];
      let hands = isSplit ? splitHands : [handPlayer];
      hands.forEach(h => {
        let playerVal = calculateHand(h);
        let dealerVal = calculateHand(handDealer);
        let outcome = 'Perso';
        let net = -betSize;
        if (h.length >= 6 && playerVal <= 21) { 
          outcome = 'Vinto (Charlie)';
          net = betSize;
        } else if (playerVal > 21) {
          bustTuoi++;
          outcome = 'Bust Tuoi';
        } else if (dealerVal > 21) {
          bustDealer++;
          outcome = 'Dealer Bust';
          net = betSize;
        } else if (playerVal > dealerVal) {
          outcome = 'Vinto';
          net = betSize;
        } else if (playerVal === dealerVal) {
          outcome = 'Pareggio';
          net = 0;
        } else {
          outcome = 'Perso';
          net = -betSize;
        }
        if (playerVal === 21 && h.length === 2) net = betSize * 1.5;
        if (bustItActive && dealerVal > 21 && handDealer.length >= 3) {
          let payout = 0;
          if (handDealer.length === 3) payout = 8;
          else if (handDealer.length === 4) payout = 10;
          else if (handDealer.length === 5) payout = 50;
          else if (handDealer.length === 6) payout = 100;
          else if (handDealer.length === 7) payout = 200;
          else if (handDealer.length >= 8) payout = 250;
          net += betSize * payout;
          outcome += ` (Bust It: ${payout}:1)`;
        }
        nets.push(net);
        if (net > 0) vinte++;
        else if (net < 0) perse++;
        else pareggi++;
      });
      let totalNet = nets.reduce((a, b) => a + b, 0);
      saldo += totalNet;
      mani++;
      let log = `Mano ${mani}: Player ${JSON.stringify(hands)} (${hands.map(calculateHand)}), Dealer ${handDealer} (${calculateHand(handDealer)}), Outcome: ${nets.map((n, i) => hands[i].join(',') + ': ' + (n > 0 ? 'Vinto' : n < 0 ? 'Perso' : 'Pareggio')).join('; ')}, Net: ${totalNet}`;
      history.push(log);
      postHandMode = true;
      document.getElementById('postHandMsg').style.display = 'block';
      updateFinances();
      updateHistory();
    }

    function resetHand() {
      handPlayer = [];
      handDealer = [];
      splitHands = [];
      isSplit = false;
      inputCount = 0;
      assignTo = 'player';
      postHandMode = false;
      document.getElementById('postHandMsg').style.display = 'none';
      updateHandsDisplay();
      updateSuggestion();
    }

    function resetShoe() {
      runningCount = 0;
      cardsDealt = 0;
      resetHand();
      updateCount();
    }

    function updateCount() {
      let decksLeft = Math.max(1, decks * (1 - cardsDealt / (decks * 52 * penetration)));
      let trueCount = runningCount / decksLeft;
      document.querySelector('.count').innerText = `Running: ${runningCount} | True: ${trueCount.toFixed(2)}`;
      localStorage.runningCount = runningCount;
      localStorage.cardsDealt = cardsDealt;
    }

    function updateSuggestion() {
      let dealerUp = handDealer[0] ? cardValues[handDealer[0]] : 0;
      let tc = getTrueCount();
      let hands = isSplit ? splitHands : [handPlayer];
      let suggestions = hands.map(h => getAction(h, dealerUp, tc));
      document.querySelector('.suggestion').innerText = `Suggerimento: ${suggestions.join(' | ')}`;
      if (handPlayer.length === 2 && handPlayer[0] === handPlayer[1] && !isSplit) {
        if (getAction(handPlayer, dealerUp, tc) === 'P') document.querySelector('.suggestion').innerText += ' (Split consigliato)';
      }
    }

    function getTrueCount() {
      let decksLeft = Math.max(1, decks * (1 - cardsDealt / (decks * 52 * penetration)));
      return runningCount / decksLeft;
    }

    function getAction(hand, dealerUp, tc) {
      let val = calculateHand(hand);
      let isSoft = hand.includes('A') && val <= 21;
      let isPair = hand.length === 2 && hand[0] === hand[1];
      if (isPair) {
        let pairVal = cardValues[hand[0]];
        if (pairVal === 11) return 'P'; 
        if (pairVal === 8) return 'P'; 
      }
      if (val <= 11) return 'H';
      if (val >= 17) return 'S';
      if (val === 12 && dealerUp >= 4 && dealerUp <= 6) return 'S';
      if (tc >= 3 && dealerUp === 11 && val === 11) return 'D'; 
      if (tc >= 0 && val === 16 && dealerUp === 10) return 'S'; 
      return 'H'; 
    }

    function calculateHand(hand) {
      let val = 0;
      let aces = 0;
      hand.forEach(c => {
        let v = cardValues[c];
        val += v;
        if (c === 'A') aces++;
      });
      while (val > 21 && aces > 0) {
        val -= 10;
        aces--;
      }
      return val;
    }

    function updateHandsDisplay() {
      document.getElementById('playerHand').innerText = `Player: ${handPlayer.join(', ')} (${calculateHand(handPlayer)})`;
      document.getElementById('dealerHand').innerText = `Dealer: ${handDealer.join(', ')} (${calculateHand(handDealer)})`;
      let splitDiv = document.getElementById('splitHands');
      splitDiv.innerHTML = '';
      if (isSplit) {
        splitHands.forEach((h, i) => {
          let div = document.createElement('div');
          div.className = 'hand';
          div.innerText = `Hand ${i+1}: ${h.join(', ')} (${calculateHand(h)})`;
          splitDiv.appendChild(div);
        });
      }
    }

    function updateFinances() {
      document.getElementById('bankroll').innerText = bankroll;
      document.getElementById('saldo').innerText = saldo;
      document.getElementById('roi').innerText = ((saldo - bankroll) / bankroll * 100).toFixed(2) + '%';
      document.getElementById('mani').innerText = mani;
      document.getElementById('vinte').innerText = vinte;
      document.getElementById('perse').innerText = perse;
      document.getElementById('pareggi').innerText = pareggi;
      document.getElementById('bustTuoi').innerText = bustTuoi;
      document.getElementById('bustDealer').innerText = bustDealer;
      localStorage.bankroll = bankroll;
      localStorage.saldo = saldo;
      localStorage.mani = mani;
      localStorage.vinte = vinte;
      localStorage.perse = perse;
      localStorage.pareggi = pareggi;
      localStorage.bustTuoi = bustTuoi;
      localStorage.bustDealer = bustDealer;
      localStorage.history = JSON.stringify(history);
    }

    function updateHistory() {
      document.getElementById('history').innerHTML = history.map(h => `<p>${h}</p>`).join('');
    }

    function exportHistory() {
      let csv = 'Mano,Outcome,Net\n' + history.join('\n');
      let blob = new Blob([csv], { type: 'text/csv' });
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = 'bj_history.csv';
      a.click();
    }

    function toggleStealth() {
      stealthMode = !stealthMode;
      document.body.classList.toggle('stealth', stealthMode);
    }

    function vibrateIfHigh() {
      let tc = getTrueCount();
      if (tc > 2 && 'vibrate' in navigator) navigator.vibrate(200);
    }

    function updateAll() {
      updateCount();
      updateHandsDisplay();
      updateSuggestion();
      updateFinances();
      updateHistory();
      document.getElementById('decks').value = decks;
      document.getElementById('penetration').value = penetration * 100;
      document.getElementById('initBankroll').value = bankroll;
      document.getElementById('betSize').value = betSize;
      document.getElementById('system').value = countSystem;
      document.getElementById('bustIt').checked = bustItActive;
    }
  </script>
</body>
</html>
