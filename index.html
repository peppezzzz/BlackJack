<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oracle DIAMOND v5.0</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #bd00ff; --glow: rgba(189, 0, 255, 0.6);
            --bg: #000; --panel: #0a0a0a; --border: #1a1a1a;
            --text: #fff; --win: #00ff88; --lose: #ff0055; --action: #00d4ff; --gold: #ffd700;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Navigazione 3 Sezioni */
        .tabs { display: flex; background: #050505; border-top: 1px solid var(--border); height: 75px; position: fixed; bottom: 0; width: 100%; z-index: 100; }
        .tab-btn { flex: 1; border: none; background: none; color: #555; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; text-transform: uppercase; font-weight: bold; }
        .tab-btn.active { color: var(--primary); text-shadow: 0 0 10px var(--glow); }

        .section { flex: 1; display: none; padding: 15px; overflow-y: auto; margin-bottom: 80px; }
        .section.active { display: block; }

        /* Game UI */
        .target-header { display: flex; gap: 8px; margin-bottom: 12px; }
        .target-box { flex: 1; background: #0f0f0f; border: 2px solid var(--border); border-radius: 12px; padding: 10px; text-align: center; position: relative; }
        .target-box.active { border-color: var(--primary); box-shadow: 0 0 20px var(--glow); }
        .sum { font-size: 28px; font-weight: 900; }
        .label { font-size: 9px; color: #888; text-transform: uppercase; }

        .strat-banner { background: #111; border: 2px solid var(--primary); border-radius: 12px; padding: 15px; text-align: center; font-size: 22px; font-weight: 900; margin-bottom: 12px; text-transform: uppercase; transition: 0.3s; }

        .keypad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 12px; }
        .key { height: 55px; border: none; border-radius: 10px; color: white; font-size: 24px; font-weight: 900; box-shadow: 0 4px #000; }
        .k-high { background: #8a1c1c; } .k-low { background: #0f5c37; } .k-mid { background: #3e413e; }
        .key:active { transform: translateY(2px); box-shadow: none; }

        .glass-card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 15px; margin-bottom: 12px; }
        .f-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #1a1a1a; font-size: 14px; }
        
        .side-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .side-btn { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--panel); color: #fff; font-weight: bold; font-size: 10px; text-align: center; }
        .side-btn.active { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 15px var(--glow); }

        .btn-main { background: var(--primary); border: none; border-radius: 12px; padding: 18px; color: white; font-weight: 900; font-size: 16px; width: 100%; box-shadow: 0 0 20px var(--glow); text-transform: uppercase; }
        
        #config-sec { background: #000; position: fixed; inset: 0; z-index: 1000; display: flex; flex-direction: column; justify-content: center; padding: 30px; }
        .config-input { background: #111; border: 1px solid var(--border); border-radius: 10px; padding: 15px; color: white; width: 100%; margin: 10px 0; font-size: 18px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="config-sec">
        <h1 style="color:var(--primary); text-align:center; font-size:36px; margin-bottom:10px;">ORACLE v5.0</h1>
        <p style="text-align:center; color:#555; font-size:12px; margin-bottom:30px;">DIAMOND EDITION • INFINITE BLACKJACK</p>
        <label class="label">BANKROLL (€)</label><input type="number" id="cfg-bank" class="config-input" value="1000">
        <label class="label">MAZZI NEL SABOT</label><input type="number" id="cfg-decks" class="config-input" value="8">
        <label class="label">PENETRAZIONE (%)</label><input type="number" id="cfg-pen" class="config-input" value="50">
        <button class="btn-main" onclick="initApp()">ATTIVA TERMINALE</button>
    </div>

    <div id="game-sec" class="section active">
        <div class="stat-card glass-card" style="display:grid; grid-template-columns: repeat(4, 1fr); text-align:center; margin-bottom:15px;">
            <div><div class="label">RC</div><div id="ui-rc" style="color:var(--primary); font-weight:bold;">0</div></div>
            <div><div class="label">TC</div><div id="ui-tc" style="color:var(--primary); font-weight:bold;">0.0</div></div>
            <div><div class="label">PUNTATA</div><div id="ui-bet" style="color:var(--win); font-weight:bold;">1€</div></div>
            <div><div class="label">CARTE</div><div id="ui-dealt">0</div></div>
        </div>

        <div class="target-header">
            <div id="box-p1" class="target-box active" onclick="setT('p1')"><div class="label">TU A</div><div id="sum-p1" class="sum">0</div></div>
            <div id="box-p2" class="target-box" style="display:none" onclick="setT('p2')"><div class="label">TU B</div><div id="sum-p2" class="sum">0</div></div>
            <div id="box-d" class="target-box" onclick="setT('d')"><div class="label">BANCO</div><div id="sum-d" class="sum">0</div></div>
            <div id="box-o" class="target-box" onclick="setT('o')" style="border-style: dashed; opacity: 0.6;"><div class="label">ALTRI</div><div id="sum-o" class="sum">--</div></div>
        </div>

        <div id="strat-box" class="strat-banner">READY</div>

        <div class="glass-card" style="display: flex; gap: 15px; text-align: center; padding: 10px;">
            <div style="flex:1"><div class="label">% 10</div><div id="p10-txt" style="color:var(--action); font-weight:bold;">30.7%</div></div>
            <div style="flex:1"><div class="label">% ASSO</div><div id="pa-txt" style="color:var(--win); font-weight:bold;">7.7%</div></div>
        </div>

        <div class="side-row">
            <div id="btn-ins" class="side-btn">ASSICURAZIONE</div>
            <div id="btn-side" class="side-btn" onclick="nav('game-sec', null)">SIDE BETS</div>
        </div>

        <div class="keypad">
            <button class="key k-high" onclick="hit(11)">A</button>
            <button class="key k-low" onclick="hit(2)">2</button>
            <button class="key k-low" onclick="hit(3)">3</button>
            <button class="key k-low" onclick="hit(4)">4</button>
            <button class="key k-low" onclick="hit(5)">5</button>
            <button class="key k-low" onclick="hit(6)">6</button>
            <button class="key k-mid" onclick="hit(7)">7</button>
            <button class="key k-mid" onclick="hit(8)">8</button>
            <button class="key k-mid" onclick="hit(9)">9</button>
            <button class="key k-high" onclick="hit(10)">10</button>
        </div>

        <div style="display:flex; gap:8px;">
            <button id="split-btn" class="act-btn" style="flex:1; background:#001a33; border:1px solid var(--action); color:var(--action); border-radius:10px; display:none; font-weight:bold;" onclick="doSplit()">SPLIT</button>
            <button class="btn-main" style="flex:2; margin-top:0;" onclick="resolve()">FINE MANO</button>
        </div>
        <button onclick="undo()" style="background:none; border:none; color:#ff8c00; width:100%; margin-top:15px; font-weight:bold; font-size:11px; text-transform:uppercase;">↶ Annulla Errore</button>
    </div>

    <div id="fin-sec" class="section">
        <h2 style="color:var(--primary); margin-bottom:20px;">REPORT FINANZE</h2>
        <div class="glass-card">
            <div class="f-row"><span>Mani Giocate</span><span id="f-h">0</span></div>
            <div class="f-row"><span>Vinte</span><span id="f-w" style="color:var(--win)">0</span></div>
            <div class="f-row"><span>Perse</span><span id="f-l" style="color:var(--lose)">0</span></div>
            <div class="f-row"><span>Sballate</span><span id="f-b" style="color:var(--lose)">0</span></div>
            <div class="f-row"><span>Pareggiate</span><span id="f-p">0</span></div>
        </div>
        <div class="glass-card">
            <div class="f-row"><span>Bankroll Iniziale</span><span id="f-start">1000€</span></div>
            <div class="f-row"><span>Saldo Attuale</span><span id="f-bal" style="font-size:20px; font-weight:bold;">1000€</span></div>
            <div class="f-row"><span>Profitto / Perdita</span><span id="f-prof">0€</span></div>
            <div class="f-row"><span>Rendimento (ROI %)</span><span id="f-roi">0.0%</span></div>
        </div>
        <h3 class="label" style="margin-top:20px;">STORICO RECENTE</h3>
        <div id="history-list"></div>
    </div>

    <div id="set-sec" class="section">
        <h2 style="color:var(--primary)">IMPOSTAZIONI</h2>
        <div class="glass-card">
            <h4 style="margin:0 0 10px 0;">RECAP CONFIGURAZIONE</h4>
            <div id="cfg-recap" style="font-size:12px; color:#888;"></div>
        </div>
        <button class="btn-main" style="background:#222; margin-bottom:10px;" onclick="resetCount()">RESET CONTEGGIO</button>
        <button class="btn-main" style="background:#8a1c1c;" onclick="fullReset()">RESET TOTALE DATI</button>
    </div>

    <div class="tabs hidden" id="navbar">
        <button class="tab-btn" onclick="nav('fin-sec', this)"><i data-lucide="bar-chart-3"></i>Finanze</button>
        <button class="tab-btn active" onclick="nav('game-sec', this)"><i data-lucide="crosshair"></i>Conteggio</button>
        <button class="tab-btn" onclick="nav('set-sec', this)"><i data-lucide="sliders-horizontal"></i>Setup</button>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, dur) {
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        let s = { 
            bank:1000, start:1000, decks:8, pen:50, rc:0, dealt:0, c10:0, cA:0, 
            p1:[], p2:[], d:[], o:[], target:'p1', isSplit:false, 
            stats:{h:0,w:0,l:0,b:0,p:0}, hist:[], log:[] 
        };
        
        const TAGS = { 11:-1, 2:1, 3:1, 4:1, 5:1, 6:1, 7:0, 8:0, 9:0, 10:-1 };

        function initApp() {
            s.start = parseFloat(document.getElementById('cfg-bank').value) || 1000;
            s.bank = s.start; s.decks = parseInt(document.getElementById('cfg-decks').value) || 8;
            s.pen = parseInt(document.getElementById('cfg-pen').value) || 50;
            document.getElementById('config-sec').style.display = 'none';
            document.getElementById('navbar').classList.remove('hidden');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            updateRecap(); update();
        }

        function hit(v) {
            playTone(440, 'sine', 0.05);
            s.rc += TAGS[v]; s.dealt++; s.log.push({ v, t: s.target });
            s[s.target].push(v);
            if(v === 10) s.c10++; if(v === 11) s.cA++;
            // Auto-switch intelligente: Tu -> Banco -> Tu
            if(!s.isSplit && s.p1.length === 1 && s.d.length === 0) s.target = 'd';
            else if(!s.isSplit && s.p1.length === 1 && s.d.length === 1) s.target = 'p1';
            update(); save();
        }

        function getSum(h) {
            let v = h.reduce((a, b) => a + b, 0), aces = h.filter(x => x === 11).length;
            while (v > 21 && aces > 0) { v -= 10; aces--; }
            return v;
        }

        function resolve() {
            let tc = s.rc / Math.max(1, (s.decks * 52 - s.dealt) / 52);
            let bet = (tc < 1) ? 1 : (tc < 2) ? 2 : (tc < 3) ? 5 : (tc < 4.5) ? 8 : 12;
            let ds = getSum(s.d);
            let hands = [s.p1]; if(s.isSplit) hands.push(s.p2);

            hands.forEach((h, idx) => {
                let ps = getSum(h), res = "", gain = 0, col = ""; s.stats.h++;
                if (ps > 21) { res = "SBALLATO"; gain = -bet; s.stats.l++; s.stats.b++; col = "var(--lose)"; playTone(200, 'sawtooth', 0.3); }
                else if (ds > 21) { res = "BANCO SBALLA"; gain = bet; s.stats.w++; col = "var(--win)"; playTone(1200, 'sine', 0.3); }
                else if (ps === 21 && h.length === 2) { res = "BLACKJACK!"; gain = bet * 1.5; s.stats.w++; col = "var(--gold)"; playTone(1500, 'sine', 0.4); }
                else if (ps > ds) { res = "HAI VINTO"; gain = bet; s.stats.w++; col = "var(--win)"; playTone(1000, 'sine', 0.2); }
                else if (ps < ds) { res = "HAI PERSO"; gain = -bet; s.stats.l++; col = "var(--lose)"; }
                else { res = "PAREGGIO"; gain = 0; s.stats.p++; col = "#888"; }
                s.bank += gain;
                s.hist.unshift({ m: (s.isSplit ? (idx===0?'A: ':'B: ') : '') + res, v: gain.toFixed(1) + "€", c: col });
                document.getElementById('strat-box').innerText = res; document.getElementById('strat-box').style.color = col;
            });

            setTimeout(() => { s.p1 = []; s.p2 = []; s.d = []; s.o = []; s.target = 'p1'; s.isSplit = false; update(); }, 2000);
            save();
        }

        function update() {
            let tc = s.rc / Math.max(1, (s.decks * 52 - s.dealt) / 52);
            let ps = getSum(s[s.target==='d'?'p1':s.target]), dv = s.d[0]||0;
            let rem = (s.decks * 52) - s.dealt;

            document.getElementById('sum-p1').innerText = getSum(s.p1);
            document.getElementById('sum-p2').innerText = getSum(s.p2);
            document.getElementById('sum-d').innerText = getSum(s.d);
            document.getElementById('ui-rc').innerText = (s.rc > 0 ? '+' : '') + s.rc;
            document.getElementById('ui-tc').innerText = tc.toFixed(1);
            document.getElementById('ui-bet').innerText = (tc < 1 ? 1 : tc < 2 ? 2 : tc < 3 ? 5 : tc < 4.5 ? 8 : 12) + "€";
            document.getElementById('p10-txt').innerText = (((s.decks * 16) - s.c10) / Math.max(1, rem) * 100).toFixed(1) + "%";
            document.getElementById('pa-txt').innerText = (((s.decks * 4) - s.cA) / Math.max(1, rem) * 100).toFixed(1) + "%";
            document.getElementById('ui-dealt').innerText = s.dealt;

            let banner = document.getElementById('strat-box');
            let isPair = s[s.target].length === 2 && s[s.target][0] === s[s.target][1];
            if (ps === 21 && s[s.target].length === 2) { banner.innerText = "BLACKJACK!"; banner.style.color = "var(--gold)"; }
            else if (ps > 21) { banner.innerText = "SBALLATO"; banner.style.color = "var(--lose)"; }
            else if (ps >= 17) { banner.innerText = "STAI"; banner.style.color = "var(--lose)"; }
            else if (ps > 0 && dv > 0) {
                if (isPair && !s.isSplit) { banner.innerText = "DIVIDI?"; banner.style.color = "var(--action)"; }
                else { banner.innerText = (dv <= 6 && ps >= 13) ? "STAI" : "CHIAMA"; banner.style.color = (dv <= 6 && ps >= 13) ? "var(--lose)" : "var(--win)"; }
            } else { banner.innerText = "READY"; banner.style.color = "var(--primary)"; }

            // Finanze Update
            document.getElementById('f-h').innerText = s.stats.h; document.getElementById('f-w').innerText = s.stats.w;
            document.getElementById('f-l').innerText = s.stats.l; document.getElementById('f-b').innerText = s.stats.b;
            document.getElementById('f-p').innerText = s.stats.p; document.getElementById('f-bal').innerText = Math.round(s.bank) + "€";
            let prof = s.bank - s.start; document.getElementById('f-prof').innerText = prof.toFixed(0) + "€";
            document.getElementById('f-roi').innerText = ((prof / s.start) * 100).toFixed(1) + "%";
            
            document.getElementById('history-list').innerHTML = s.hist.slice(0, 10).map(i => `<div class="f-row"><span>${i.m}</span><span style="color:${i.c}">${i.v}</span></div>`).join('');
            
            // Side Bets Highlights
            document.getElementById('btn-ins').className = (dv === 11 && tc >= 3) ? "side-btn active" : "side-btn";
            document.getElementById('btn-side').className = (tc >= 5) ? "side-btn active" : "side-btn";

            // Visual Targets
            document.getElementById('box-p1').className = "target-box " + (s.target === 'p1' ? 'active' : '');
            document.getElementById('box-p2').className = "target-box " + (s.target === 'p2' ? 'active' : '');
            document.getElementById('box-d').className = "target-box " + (s.target === 'd' ? 'active' : '');
            document.getElementById('box-o').className = "target-box " + (s.target === 'o' ? 'active' : '');
            
            document.getElementById('split-btn').style.display = (!s.isSplit && isPair && s.target === 'p1') ? 'block' : 'none';
            document.getElementById('box-p2').style.display = s.isSplit ? 'block' : 'none';
            lucide.createIcons();
        }

        function setT(t) { playTone(600, 'sine', 0.05); s.target = t; update(); }
        function doSplit() { s.isSplit = true; s.p2 = [s.p1.pop()]; s.target = 'p1'; playTone(600, 'sine', 0.1); update(); }
        function undo() { if (s.log.length) { let l = s.log.pop(); s[l.t].pop(); s.rc -= TAGS[l.v]; if (l.v === 10) s.c10--; if (l.v === 11) s.cA--; s.dealt--; update(); } }
        function resetCount() { s.rc = 0; s.dealt = 0; s.c10 = 0; s.cA = 0; update(); playTone(440, 'sawtooth', 0.2); }
        function fullReset() { if (confirm("CANCELLARE TUTTO IL DATABASE?")) { localStorage.clear(); location.reload(); } }
        function updateRecap() { document.getElementById('cfg-recap').innerHTML = `Bankroll: ${s.start}€<br>Mazzi: ${s.decks}<br>Taglio: ${s.pen}%`; }
        function save() { localStorage.setItem('oracle_diamond_v5', JSON.stringify(s)); }
        function load() { let d = localStorage.getItem('oracle_diamond_v5'); if (d) { s = JSON.parse(d); document.getElementById('config-sec').style.display = 'none'; document.getElementById('navbar').classList.remove('hidden'); updateRecap(); update(); } }
        function nav(id, btn) { document.querySelectorAll('.section').forEach(x => x.classList.remove('active')); document.getElementById(id).classList.add('active'); if(btn){document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active')); btn.classList.add('active');} lucide.createIcons(); }
        window.onload = () => { load(); lucide.createIcons(); };
    </script>
</body>
</html>
